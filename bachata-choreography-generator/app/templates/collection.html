{% extends "base.html" %}

{% block title %}My Collection - Bachata Choreography Generator{% endblock %}

{% block content %}
<div class="min-h-screen p-4" x-data="collectionManager()">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-white mb-4">
                My Choreography Collection
            </h2>
            <p class="text-white/80 text-lg">
                Manage and view your saved choreographies
            </p>
        </div>
        
        <!-- Collection Grid -->
        <div x-show="!loading && choreographies.length > 0" 
             class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <template x-for="choreography in choreographies" :key="choreography.id">
                <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-6 animate-fade-in">
                    <!-- Video Thumbnail/Player -->
                    <div class="mb-4">
                        <video :src="`/api/video/${choreography.video_filename}`" 
                               controls
                               class="w-full rounded-lg shadow-md">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    
                    <!-- Choreography Info -->
                    <div class="space-y-3">
                        <h3 class="text-xl font-bold text-gray-900" x-text="choreography.title"></h3>
                        
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><strong>Created:</strong> <span x-text="formatDate(choreography.created_at)"></span></p>
                            <p><strong>Duration:</strong> <span x-text="choreography.metadata?.sequence_duration ? choreography.metadata.sequence_duration.toFixed(1) + 's' : 'N/A'"></span></p>
                            <p><strong>Moves:</strong> <span x-text="choreography.metadata?.moves_analyzed || 'N/A'"></span></p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex space-x-2 pt-4">
                            <button @click="downloadChoreography(choreography)" 
                                    class="flex-1 bg-primary-500 hover:bg-primary-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200">
                                Download
                            </button>
                            <button @click="deleteChoreography(choreography.id)" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold transition-colors duration-200">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Empty State -->
        <div x-show="!loading && choreographies.length === 0" 
             class="text-center py-16">
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-12 max-w-md mx-auto">
                <div class="text-gray-400 mb-6">
                    <svg class="w-24 h-24 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-4">No Choreographies Yet</h3>
                <p class="text-gray-600 mb-6">Start creating choreographies to build your collection!</p>
                <a href="/" 
                   class="inline-block bg-gradient-to-r from-primary-500 to-secondary-500 text-white py-3 px-6 rounded-lg font-semibold hover:from-primary-600 hover:to-secondary-600 transition-all duration-200">
                    Create Choreography
                </a>
            </div>
        </div>
        
        <!-- Loading State -->
        <div x-show="loading" 
             class="text-center py-16">
            <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl p-12 max-w-md mx-auto">
                <div class="animate-spin w-12 h-12 border-4 border-primary-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Loading your collection...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function collectionManager() {
        return {
            choreographies: [],
            loading: true,
            
            async init() {
                await this.loadCollection();
            },
            
            async loadCollection() {
                try {
                    this.loading = true;
                    
                    const response = await fetch('/api/collection', {
                        headers: {
                            'Authorization': `Bearer ${this.$root.user.token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.choreographies = data.choreographies || [];
                    } else {
                        throw new Error('Failed to load collection');
                    }
                } catch (error) {
                    console.error('Error loading collection:', error);
                    this.$root.showNotification('Failed to load collection', 'error');
                } finally {
                    this.loading = false;
                }
            },
            
            async deleteChoreography(choreographyId) {
                if (!confirm('Are you sure you want to delete this choreography?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/collection/${choreographyId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${this.$root.user.token}`
                        }
                    });
                    
                    if (response.ok) {
                        this.choreographies = this.choreographies.filter(c => c.id !== choreographyId);
                        this.$root.showNotification('Choreography deleted successfully', 'success');
                    } else {
                        throw new Error('Failed to delete choreography');
                    }
                } catch (error) {
                    console.error('Error deleting choreography:', error);
                    this.$root.showNotification('Failed to delete choreography', 'error');
                }
            },
            
            downloadChoreography(choreography) {
                // Create download link
                const link = document.createElement('a');
                link.href = `/api/video/${choreography.video_filename}`;
                link.download = `${choreography.title}.mp4`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.$root.showNotification('Download started', 'info');
            },
            
            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
    }
</script>
{% endblock %}